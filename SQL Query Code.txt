ALTER TABLE [CPADS].[dbo].[Responses]
ADD PRIMARY KEY (SEQID);

CREATE TABLE Codebook (
[Variable_Name] nvarchar(50),
[Code] int,
[Label] nvarchar(MAX),
);

BULK INSERT [CPADS].[dbo].[Codebook]
FROM 'C:\Users\tabor\code_mappings.csv'
WITH (FIRSTROW = 2,
	FIELDTERMINATOR = ',',
	ROWTERMINATOR = '\n' );
	
CREATE OR ALTER VIEW [dbo].[CPADS_Decoded] AS
SELECT 
    r.SEQID AS Case_ID,
    r.wtpumf AS Weight_Values,
    s.Label AS Enrollment_Status,
    reg.Label AS School_Region,
    a.Label AS Age_Category,
    g.Label AS Gender,
    e.Label AS Ethnicity,
    ph.Label AS Physical_Health,
    mh.Label AS Mental_Health,
    alc5.Label AS Alcohol_Past_12M,
    alc6.Label AS Alcohol_30D_Frequency,
    alc10.Label AS Alcohol_30D_Drinks,
    can5.Label AS Cannabis_Past_12M,
    can6.Label AS Cannabis_30D_Frequency,
    vap.Label AS Vaping_Frequency
FROM [dbo].[Responses] r
LEFT JOIN [dbo].[Codebook] s ON s.Variable_Name = 'stu04' AND r.stu04 = s.Code
LEFT JOIN [dbo].[Codebook] reg ON reg.Variable_Name = 'region' AND r.region = reg.Code
LEFT JOIN [dbo].[Codebook] a ON a.Variable_Name = 'age_groups' AND r.age_groups = a.Code
LEFT JOIN [dbo].[Codebook] g ON g.Variable_Name = 'dvdemq01' AND r.dvdemq01 = g.Code
LEFT JOIN [dbo].[Codebook] e ON e.Variable_Name = 'dvdemq6' AND r.dvdemq6 = e.Code
LEFT JOIN [dbo].[Codebook] ph ON ph.Variable_Name = 'hwbq01' AND r.hwbq01 = ph.Code
LEFT JOIN [dbo].[Codebook] mh ON mh.Variable_Name = 'hwbq02' AND r.hwbq02 = mh.Code
LEFT JOIN [dbo].[Codebook] alc5 ON alc5.Variable_Name = 'alc05' AND r.alc05 = alc5.Code
LEFT JOIN [dbo].[Codebook] alc6 ON alc6.Variable_Name = 'alc06' AND r.alc06 = alc6.Code
LEFT JOIN [dbo].[Codebook] alc10 ON alc10.Variable_Name = 'alc10' AND r.alc10 = alc10.Code
LEFT JOIN [dbo].[Codebook] can5 ON can5.Variable_Name = 'can05' AND r.can05 = can5.Code
LEFT JOIN [dbo].[Codebook] can6 ON can6.Variable_Name = 'can06' AND r.can06 = can6.Code
LEFT JOIN [dbo].[Codebook] vap ON vap.Variable_Name = 'vap01' AND r.vap01 = vap.Code;


